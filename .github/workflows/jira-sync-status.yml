name: Sync Issue Status with Jira

on:
  issues:
    types: [closed, reopened]
  pull_request:
    types: [opened, closed]

jobs:
  sync-status:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”‘ Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: âœ‚ï¸ Extract Jira key from title
        id: extract
        run: |
          title="${{ github.event.issue.title || github.event.pull_request.title || '' }}"
          jira_key=$(echo "$title" | python3 -c "import re, sys; m = re.search(r'([A-Z][A-Z0-9]+-\d+)', sys.stdin.read()); print(m.group(1) if m else '')")
          
          if [ -n "$jira_key" ]; then
            echo "âœ… Found: $jira_key"
            echo "jira_key=$jira_key" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No Jira key found"
            exit 0
          fi

      - name: ðŸ”„ Get transitions
        id: transitions
        if: steps.extract.outputs.jira_key
        run: |
          jira_key="${{ steps.extract.outputs.jira_key }}"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64 | tr -d '\n')" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$jira_key/transitions")
          
          http_status=$(echo "$response" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          
          if [ "$http_status" != "200" ]; then
            echo "âŒ Failed to get transitions"
            exit 0
          fi
          
          json=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          done_id=$(echo "$json" | python3 -c "import json, sys, re; d=json.load(sys.stdin); print(next((t['id'] for t in d.get('transitions',[]) if re.search(r'Done|ì™„ë£Œ', t['name'], re.I)), ''))")
          progress_id=$(echo "$json" | python3 -c "import json, sys, re; d=json.load(sys.stdin); print(next((t['id'] for t in d.get('transitions',[]) if re.search(r'In Progress|ì§„í–‰', t['name'], re.I)), ''))")
          todo_id=$(echo "$json" | python3 -c "import json, sys, re; d=json.load(sys.stdin); print(next((t['id'] for t in d.get('transitions',[]) if re.search(r'To Do|í•  ì¼', t['name'], re.I)), ''))")
          
          echo "done_id=$done_id" >> $GITHUB_OUTPUT
          echo "progress_id=$progress_id" >> $GITHUB_OUTPUT
          echo "todo_id=$todo_id" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Update Jira status
        if: steps.extract.outputs.jira_key
        run: |
          jira_key="${{ steps.extract.outputs.jira_key }}"
          auth="Authorization: Basic $(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64 | tr -d '\n')"
          
          # Issue closed â†’ Done
          if [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.issue }}" ] && [ -n "${{ steps.transitions.outputs.done_id }}" ]; then
            curl -s -X POST -H "$auth" -H "Content-Type: application/json" \
              -d "{\"transition\":{\"id\":\"${{ steps.transitions.outputs.done_id }}\"}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$jira_key/transitions"
            echo "âœ… Issue closed â†’ Done"
          
          # Issue reopened â†’ To Do
          elif [ "${{ github.event.action }}" = "reopened" ] && [ -n "${{ steps.transitions.outputs.todo_id }}" ]; then
            curl -s -X POST -H "$auth" -H "Content-Type: application/json" \
              -d "{\"transition\":{\"id\":\"${{ steps.transitions.outputs.todo_id }}\"}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$jira_key/transitions"
            echo "ðŸ”„ Issue reopened â†’ To Do"
          
          # PR opened â†’ In Progress
          elif [ "${{ github.event.action }}" = "opened" ] && [ "${{ github.event.pull_request }}" ] && [ -n "${{ steps.transitions.outputs.progress_id }}" ]; then
            curl -s -X POST -H "$auth" -H "Content-Type: application/json" \
              -d "{\"transition\":{\"id\":\"${{ steps.transitions.outputs.progress_id }}\"}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$jira_key/transitions"
            echo "ðŸš€ PR opened â†’ In Progress"
          
          # PR merged â†’ Done
          elif [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ] && [ -n "${{ steps.transitions.outputs.done_id }}" ]; then
            curl -s -X POST -H "$auth" -H "Content-Type: application/json" \
              -d "{\"transition\":{\"id\":\"${{ steps.transitions.outputs.done_id }}\"}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$jira_key/transitions"
            echo "âœ… PR merged â†’ Done"
          fi
