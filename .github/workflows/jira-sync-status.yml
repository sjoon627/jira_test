name: Sync Issue Status with Jira

on:
  issues:
    types: [closed, reopened]
  pull_request:
    types: [opened, closed, merged]

jobs:
  sync-status:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Extract Jira Key from Title
        id: extract
        run: |
          title="${{ github.event.issue.title || github.event.pull_request.title }}"
          if [[ "$title" =~ \[([A-Z]+-[0-9]+)\] ]]; then
            echo "jira_key=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          fi

      # Jira 전환(transition) 확인을 위한 API 호출
      - name: Get Available Transitions
        if: steps.extract.outputs.jira_key
        id: transitions
        run: |
          response=$(curl -s -X GET \
            -H "Authorization: Basic $(echo -n ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${{ steps.extract.outputs.jira_key }}/transitions")

          echo "Available transitions:"
          echo "$response" | jq '.transitions[] | {id: .id, name: .name}'

          # 일반적인 전환 ID 찾기
          done_id=$(echo "$response" | jq -r '.transitions[] | select(.name | test("Done|완료|Closed|종료"; "i")) | .id' | head -1)
          in_progress_id=$(echo "$response" | jq -r '.transitions[] | select(.name | test("In Progress|진행 중|진행중"; "i")) | .id' | head -1)
          review_id=$(echo "$response" | jq -r '.transitions[] | select(.name | test("In Review|Review|검토|리뷰"; "i")) | .id' | head -1)
          todo_id=$(echo "$response" | jq -r '.transitions[] | select(.name | test("To Do|할 일|대기"; "i")) | .id' | head -1)

          echo "done_id=$done_id" >> $GITHUB_OUTPUT
          echo "in_progress_id=$in_progress_id" >> $GITHUB_OUTPUT
          echo "review_id=$review_id" >> $GITHUB_OUTPUT
          echo "todo_id=$todo_id" >> $GITHUB_OUTPUT

      - name: Update Jira Status - Issue Closed
        if: github.event.action == 'closed' && github.event.issue && steps.extract.outputs.jira_key && steps.transitions.outputs.done_id
        run: |
          curl -X POST \
            -H "Authorization: Basic $(echo -n ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
            -H "Content-Type: application/json" \
            -d '{"transition": {"id": "${{ steps.transitions.outputs.done_id }}"}}' \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${{ steps.extract.outputs.jira_key }}/transitions"

      - name: Update Jira Status - Issue Reopened
        if: github.event.action == 'reopened' && steps.extract.outputs.jira_key && steps.transitions.outputs.todo_id
        run: |
          curl -X POST \
            -H "Authorization: Basic $(echo -n ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
            -H "Content-Type: application/json" \
            -d '{"transition": {"id": "${{ steps.transitions.outputs.todo_id }}"}}' \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${{ steps.extract.outputs.jira_key }}/transitions"

      - name: Update Jira Status - PR Opened
        if: github.event.action == 'opened' && github.event.pull_request && steps.extract.outputs.jira_key && steps.transitions.outputs.review_id
        run: |
          curl -X POST \
            -H "Authorization: Basic $(echo -n ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
            -H "Content-Type: application/json" \
            -d '{"transition": {"id": "${{ steps.transitions.outputs.review_id }}"}}' \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${{ steps.extract.outputs.jira_key }}/transitions"

      - name: Update Jira Status - PR Merged
        if: github.event.pull_request.merged == true && steps.extract.outputs.jira_key && steps.transitions.outputs.done_id
        run: |
          curl -X POST \
            -H "Authorization: Basic $(echo -n ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
            -H "Content-Type: application/json" \
            -d '{"transition": {"id": "${{ steps.transitions.outputs.done_id }}"}}' \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${{ steps.extract.outputs.jira_key }}/transitions"

      # 디버깅용 - 전환 실패 시 로그 출력
      - name: Debug - Show Current Issue Status
        if: always() && steps.extract.outputs.jira_key
        run: |
          curl -s -X GET \
            -H "Authorization: Basic $(echo -n ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${{ steps.extract.outputs.jira_key }?fields=status" | \
            jq '.fields.status'
