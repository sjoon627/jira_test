name: Create Jira Issue and Branch from Issue Form

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: write

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      # Issue Formsì˜ ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ ë³€ìˆ˜ë¡œ ì €ì¥
      - name: Parse Issue Form Data
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            console.log("Issue Body:", issueBody);

            // ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ê° í•„ë“œì˜ ê°’ì„ ì¶”ì¶œ
            const parseField = (fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*(.+?)(?=\\n\\n###|\\n\\n_No response_|$)`, 's');
              const match = issueBody.match(regex);
              return match ? match[1].trim() : '';
            };

            // ê° í•„ë“œ íŒŒì‹±
            const issueType = parseField('ì´ìŠˆ ìœ í˜•');
            const epicNumber = parseField('ìƒìœ„ ì—í”½ ì´ìŠˆ í‚¤');
            const issueLabel = parseField('GitHub ë ˆì´ë¸” ì¶”ê°€');
            const branchName = parseField('ë¸Œëœì¹˜ëª…');
            const issueDescription = parseField('ì´ìŠˆ ìƒì„¸ ì„¤ëª…');

            // ì‘ì—… ëª©ë¡ íŒŒì‹± (ì²´í¬ë°•ìŠ¤)
            const taskListRegex = /### ì‘ì—… ëª©ë¡ \(ì²´í¬ë¦¬ìŠ¤íŠ¸\)\s*\n((?:- \[.\].+\n?)+)/;
            const taskListMatch = issueBody.match(taskListRegex);
            const taskList = taskListMatch ? taskListMatch[1].trim() : '';

            // ì¶œë ¥ ì„¤ì •
            core.setOutput('issue_type', issueType);
            core.setOutput('epic_number', epicNumber);
            core.setOutput('issue_label', issueLabel);
            core.setOutput('branch_name', branchName);
            core.setOutput('issue_description', issueDescription);
            core.setOutput('task_list', taskList);

            // ë””ë²„ê¹…ìš© ë¡œê·¸
            console.log('Parsed values:');
            console.log('issue_type:', issueType);
            console.log('epic_number:', epicNumber);
            console.log('issue_label:', issueLabel);
            console.log('branch_name:', branchName);
            console.log('issue_description:', issueDescription);
            console.log('task_list:', taskList);

      # Jira ë¡œê·¸ì¸
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # Jira ì´ìŠˆ ìƒì„±ì„ ìœ„í•œ ì„¤ëª… ì¡°í•©
      - name: Prepare Jira Description
        id: prep_description
        run: |
          # ì‘ì—… ëª©ë¡ì„ Jira í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          tasks="${{ steps.parse.outputs.task_list }}"

          # ìµœì¢… ì„¤ëª… ì¡°í•©
          description=$(cat <<EOF
          ${{ steps.parse.outputs.issue_description }}

          ---
          h3. ì‘ì—… ëª©ë¡
          $tasks

          ---
          _Original GitHub Issue:_ ${{ github.event.issue.html_url }}
          EOF
          )

          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$description" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Epic í•„ë“œ ì¤€ë¹„
      - name: Prepare Fields
        id: prep_fields
        run: |
          epic_key="${{ steps.parse.outputs.epic_number }}"
          if [ -n "$epic_key" ] && [ "$epic_key" != "_No response_" ]; then
            echo "fields={\"parent\":{\"key\":\"$epic_key\"}}" >> $GITHUB_OUTPUT
          else
            echo "fields={}" >> $GITHUB_OUTPUT
          fi

      # Jira ì´ìŠˆ ìƒì„±
      - name: Create Jira Issue
        id: create_jira
        uses: atlassian/gajira-create@v3
        with:
          project: TEST1
          issuetype: ${{ steps.parse.outputs.issue_type }}
          summary: ${{ github.event.issue.title }}
          description: ${{ steps.prep_description.outputs.description }}
          fields: ${{ steps.prep_fields.outputs.fields }}

      # ìƒì„±ëœ Jira í‚¤ë¡œ GitHub ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸
      - name: Update GitHub Issue Title
        if: steps.create_jira.outputs.issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              title: `[${{ steps.create_jira.outputs.issue }}] ${{ github.event.issue.title }}`
            })

      # ì…ë ¥ëœ GitHub ë ˆì´ë¸” ì¶”ê°€
      - name: Add GitHub Labels
        if: steps.parse.outputs.issue_label
        uses: actions/github-script@v7
        with:
          script: |
            const labelString = '${{ steps.parse.outputs.issue_label }}';
            if (labelString && labelString !== '_No response_') {
              const labels = labelString.split(',').map(l => l.trim()).filter(l => l);
              if (labels.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: labels
                });
              }
            }

      # ë¸Œëœì¹˜ ìë™ ìƒì„±
      - name: Checkout repository
        if: steps.parse.outputs.branch_name && steps.parse.outputs.branch_name != '_No response_'
        uses: actions/checkout@v4

      - name: Create Branch
        id: create_branch
        if: steps.parse.outputs.branch_name && steps.parse.outputs.branch_name != '_No response_' && steps.create_jira.outputs.issue
        run: |
          ISSUE_KEY="${{ steps.create_jira.outputs.issue }}"
          RAW_BRANCH_NAME="${{ steps.parse.outputs.branch_name }}"
          # Jira í‚¤ë¥¼ ë¸Œëœì¹˜ëª…ì— í¬í•¨ (ëŒ€ê´„í˜¸ ëŒ€ì‹  ìŠ¬ë˜ì‹œ ì‚¬ìš©: feat/TEST1-39/login)
          if [[ "$RAW_BRANCH_NAME" == feat/* ]]; then
            # feat/login -> feat/TEST1-39/login
            BRANCH_NAME=$(echo "$RAW_BRANCH_NAME" | sed "s|feat/|feat/$ISSUE_KEY/|")
          elif [[ "$RAW_BRANCH_NAME" == fix/* ]]; then
            # fix/bug -> fix/TEST1-39/bug
            BRANCH_NAME=$(echo "$RAW_BRANCH_NAME" | sed "s|fix/|fix/$ISSUE_KEY/|")
          elif [[ "$RAW_BRANCH_NAME" == chore/* ]]; then
            # chore/update -> chore/TEST1-39/update
            BRANCH_NAME=$(echo "$RAW_BRANCH_NAME" | sed "s|chore/|chore/$ISSUE_KEY/|")
          else
            # ê¸°ë³¸: ì•ì— ì´ìŠˆ í‚¤ ì¶”ê°€
            BRANCH_NAME="${ISSUE_KEY}/${RAW_BRANCH_NAME}"
          fi
          
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          echo "Branch '$BRANCH_NAME' created and pushed."
          
          # GitHub ì¶œë ¥ ë³€ìˆ˜ì— ë¸Œëœì¹˜ëª… ì €ì¥
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      # Development ì„¹ì…˜ì— ë¸Œëœì¹˜ ì—°ê²°
      - name: Link Branch to Issue Development
        if: steps.create_branch.outputs.branch_name
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.create_branch.outputs.branch_name }}';
            const issueNumber = context.issue.number;
            
            // GraphQLì„ ì‚¬ìš©í•˜ì—¬ ë¸Œëœì¹˜ë¥¼ ì´ìŠˆì™€ ì—°ê²°
            const mutation = `
              mutation($repositoryId: ID!, $issueId: ID!, $ref: String!) {
                createLinkedBranch(input: {
                  repositoryId: $repositoryId,
                  issueId: $issueId,
                  ref: $ref
                }) {
                  linkedBranch {
                    id
                    ref
                  }
                }
              }
            `;
            
            try {
              // Repository IDì™€ Issue ID ê°€ì ¸ì˜¤ê¸°
              const repoData = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const issueData = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              // GraphQL ì‹¤í–‰
              const result = await github.graphql(mutation, {
                repositoryId: repoData.data.node_id,
                issueId: issueData.data.node_id,
                ref: branchName
              });
              
              console.log('Branch linked successfully:', result);
              
              // ì¶”ê°€ë¡œ ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸°
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸŒ¿ Development branch \`${branchName}\` has been created and linked to this issue.\n\nYou can see it in the Development section on the right sidebar.`
              });
              
            } catch (error) {
              console.error('Failed to link branch:', error);
              // GraphQLì´ ì‹¤íŒ¨í•˜ë©´ ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ PR ì—†ì´ ë¸Œëœì¹˜ ì •ë³´ë§Œ ì½”ë©˜íŠ¸ë¡œ ë‚¨ê¹€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸŒ¿ Branch \`${branchName}\` has been created.\n\nTo link it to this issue:\n1. Create a PR from this branch\n2. Or manually link it in the Development section`
              });
            }
